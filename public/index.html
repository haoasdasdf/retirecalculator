<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Retirement Simulator</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .language-selector select {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .language-selector select option { background: #1a1a2e; color: #fff; }
        
        .input-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group { display: flex; flex-direction: column; }
        
        .input-group label {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .input-group input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 15px rgba(0,217,255,0.3);
        }
        
        .logic-note {
            background: rgba(255,217,61,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #ffd93d;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,217,255,0.4);
        }
        
        .results-section { display: none; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 18px;
            backdrop-filter: blur(10px);
        }
        
        .card h3 { font-size: 0.85rem; color: #aaa; margin-bottom: 8px; }
        .card .value { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .card .detail { font-size: 0.75rem; color: #888; }
        
        .chart-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container h3 { margin-bottom: 15px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(255,255,255,0.1); font-weight: bold; }
        tr:hover { background: rgba(255,255,255,0.05); }
        
        .good { color: #00ff88; }
        .bad { color: #ff6b6b; }
        .avg { color: #ffd93d; }
        .depleted { color: #ff6b6b; font-weight: bold; }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .input-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">ðŸŽ¯ FIRE Retirement Simulator</h1>
            <div class="language-selector">
                <select id="language" onchange="changeLanguage()">
                    <option value="en">ðŸ‡ºðŸ‡¸ ENGLISH</option>
                    <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
                    <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                    <option value="ko">ðŸ‡°ðŸ‡· í•œêµ­ì–´</option>
                    <option value="th">ðŸ‡¹ðŸ‡­ à¹„à¸—à¸¢</option>
                    <option value="vi">ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t</option>
                </select>
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-grid">
                <div class="input-group">
                    <label id="lblInitialDeposit">Initial Deposit (USD)</label>
                    <input type="number" id="initialDeposit" value="1000" min="0">
                </div>
                <div class="input-group">
                    <label id="lblMonthlyContribution">Monthly Contribution (USD)</label>
                    <input type="number" id="monthlyContribution" value="0" min="0" step="0.1">
                </div>
                <div class="input-group">
                    <label id="lblSpendingPercent">Annual Spending (%)</label>
                    <input type="number" id="spendingPercent" value="4" min="0" max="10" step="0.1">
                </div>
                <div class="input-group">
                    <label id="lblAvgReturn">Avg Annual Return (%)</label>
                    <input type="number" id="avgReturn" value="7" min="-10" max="30" step="0.1">
                </div>
                <div class="input-group">
                    <label id="lblYears">Simulation Years</label>
                    <input type="number" id="years" value="10" min="1" max="50">
                </div>
            </div>
            
            <div class="logic-note" id="logicNote">
                <div id="noticeTittle">ðŸ“Œ Calculation Logic:</div>
                <div id="noticeOne">1. Beginning of year: Balance - Annual Spending</div>
                <div id="noticeTwo">2. End of year: Balance Ã— (1 + Return Rate)</div>
            </div>
            
            <button class="btn" id="runBtn" onclick="runSimulation()">ðŸš€ Run Simulation</button>
        </div>
        
        <div class="results-section" id="results">
            <div class="summary-cards">
                <div class="card">
                    <h3 id="lblSummaryInitial">ðŸ’° Initial Deposit</h3>
                    <div class="value" id="summaryInitial">-</div>
                    <div class="detail" id="lblUnit">USD</div>
                </div>
                <div class="card">
                    <h3 id="lblSummarySpending">ðŸ“Š Annual Spending</h3>
                    <div class="value" id="summarySpending">-</div>
                    <div class="detail" id="lblSummaryMonthly">(Monthly - USD)</div>
                </div>
                <div class="card">
                    <h3 id="lblSummaryContribution">ðŸ’µ Monthly Contribution</h3>
                    <div class="value" id="summaryContribution">-</div>
                    <div class="detail" ><span class="value" id="yearlyContribution" >-</span> <span id="lblSummaryContributionDetail">USD/Year</span></div>
                </div>
                <div class="card">
                    <h3 id="lblFinalBest">ðŸ“ˆ Final Balance (Best)</h3>
                    <div class="value good" id="summaryBest">-</div>
                </div>
                <div class="card">
                    <h3 id="lblFinalWorst">ðŸ“‰ Final Balance (Worst)</h3>
                    <div class="value bad" id="summaryWorst">-</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 id="chartTitle">ðŸ“Š Portfolio Balance Over Time</h3>
                <canvas id="chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 id="tableTitle">ðŸ“‹ Yearly Details</h3>
                <div style="overflow-x: auto;">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th id="thYear">Year</th>
                                <th id="thGoodFirst" class="good">Good Years First</th>
                                <th id="thBadFirst" class="bad">Bad Years First</th>
                                <th id="thRandom" class="avg">Random</th>
                                <th id="thAverage">Average</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let chart = null;
        let translations = {};
        
        function formatCurrency(value) {
            return Math.max(0, value / 10000).toFixed(1);
        }
        
        async function loadTranslations() {
            const response = await fetch('/api/translations');
            translations = await response.json();
        }
        
        function changeLanguage() {
            const lang = document.getElementById('language').value;
            const t = translations[lang];
            
            // Check if translations are loaded
            if (!t) {
                // Retry loading translations
                loadTranslations().then(() => {
                    changeLanguage();
                });
                return;
            }
            
            document.getElementById('noticeTittle').textContent = t.noticeTittle;
            document.getElementById('noticeOne').textContent = t.noticeOne;
            document.getElementById('noticeTwo').textContent = t.noticeTwo;
            document.getElementById('pageTitle').textContent = 'ðŸŽ¯ ' + t.title;
            document.getElementById('lblInitialDeposit').textContent = t.initialDeposit + ' (' + t.unit + ')';
            document.getElementById('lblMonthlyContribution').textContent = t.monthlyContribution + ' (' + t.unit + ')';
            document.getElementById('lblSpendingPercent').textContent = t.annualSpending;
            document.getElementById('lblAvgReturn').textContent = t.avgReturn;
            document.getElementById('lblYears').textContent = t.years;
            document.getElementById('runBtn').textContent = t.runBtn;
            document.getElementById('lblSummaryInitial').textContent = 'ðŸ’° ' + t.summaryInitial;
            document.getElementById('lblSummarySpending').textContent = 'ðŸ“Š ' + t.summarySpending;
            // lblSummaryMonthly is set dynamically in displayResults()
            document.getElementById('lblSummaryContribution').textContent = 'ðŸ’µ ' + t.summaryContribution;
            document.getElementById('lblSummaryContributionDetail').textContent = t.unit + '/' + t.yearLabel;
            document.getElementById('lblFinalBest').textContent = 'ðŸ“ˆ ' + t.finalBest;
            document.getElementById('lblFinalWorst').textContent = 'ðŸ“‰ ' + t.finalWorst;
            document.getElementById('chartTitle').textContent = 'ðŸ“Š ' + t.chartTitle;
            document.getElementById('tableTitle').textContent = 'ðŸ“‹ ' + t.tableTitle;
            document.getElementById('thYear').textContent = t.tableYear;
            document.getElementById('thGoodFirst').textContent = t.goodFirst;
            document.getElementById('thBadFirst').textContent = t.badFirst;
            document.getElementById('thRandom').textContent = t.random;
            document.getElementById('thAverage').textContent = t.average;
            document.getElementById('lblUnit').textContent = t.unit;
            
            document.documentElement.lang = lang;
        }
        
        async function runSimulation() {
            const initialDeposit = document.getElementById('initialDeposit').value;
            const monthlyContribution = document.getElementById('monthlyContribution').value;
            const spendingPercent = document.getElementById('spendingPercent').value;
            const avgReturn = document.getElementById('avgReturn').value;
            const years = document.getElementById('years').value;
            
            try {
                const response = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initialDeposit: initialDeposit * 10000,
                        monthlyContribution: monthlyContribution * 10000,
                        spendingPercent: parseFloat(spendingPercent),
                        avgReturn: parseFloat(avgReturn),
                        years: parseInt(years)
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed: ' + response.status);
                }
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Simulation error:', error);
                alert('Error running simulation: ' + error.message);
            }
        }
        
        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            document.getElementById('summaryInitial').textContent = formatCurrency(data.input.initialDeposit);
            document.getElementById('summarySpending').textContent = formatCurrency(data.input.annualSpending);
            document.getElementById('summaryContribution').textContent = formatCurrency(data.input.monthlyContribution);
            document.getElementById('yearlyContribution').textContent  = Number(document.getElementById('summaryContribution').textContent) * 12;
            
            // Calculate and display monthly spending
            const monthlySpending = data.input.annualSpending / 12;
            const currentLang = document.getElementById('language').value;
            const langUnit = (translations[currentLang] && translations[currentLang].unit) ? translations[currentLang].unit : 'USD';
            const lblSummaryMonthlyEl = document.getElementById('lblSummaryMonthly');
            if (lblSummaryMonthlyEl) {
                lblSummaryMonthlyEl.textContent = '(' + formatCurrency(monthlySpending) + ' ' + langUnit + '/æœˆ)';
            }
            
            const finalBalances = {
                good: data.scenarios.goodYearsFirst[data.scenarios.goodYearsFirst.length - 1].balance,
                bad: data.scenarios.badYearsFirst[data.scenarios.badYearsFirst.length - 1].balance,
                random: data.scenarios.random[data.scenarios.random.length - 1].balance,
                avg: data.scenarios.average[data.scenarios.average.length - 1].balance
            };
            
            const best = Math.max(...Object.values(finalBalances));
            const worst = Math.min(...Object.values(finalBalances));
            
            document.getElementById('summaryBest').textContent = formatCurrency(best);
            document.getElementById('summaryWorst').textContent = formatCurrency(worst);
            
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            
            const lang = document.getElementById('language').value;
            const t = translations[lang] || translations.en; // Fallback to English
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.scenarios.goodYearsFirst.map(d => 'Y' + d.year),
                    datasets: [
                        {
                            label: t.goodFirst,
                            data: data.scenarios.goodYearsFirst.map(d => d.balance),
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0,255,136,0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: t.badFirst,
                            data: data.scenarios.badYearsFirst.map(d => d.balance),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255,107,107,0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: t.random,
                            data: data.scenarios.random.map(d => d.balance),
                            borderColor: '#ffd93d',
                            backgroundColor: 'rgba(255,217,61,0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: t.average,
                            data: data.scenarios.average.map(d => d.balance),
                            borderColor: '#00d9ff',
                            backgroundColor: 'rgba(0,217,255,0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
            
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = '';
            
            for (let i = 0; i < data.scenarios.goodYearsFirst.length; i++) {
                const goodData = data.scenarios.goodYearsFirst[i];
                const badData = data.scenarios.badYearsFirst[i];
                const randomData = data.scenarios.random[i];
                const avgData = data.scenarios.average[i];
                
                const row = document.createElement('tr');
                const goodClass = goodData.depleted ? 'depleted' : 'good';
                const badClass = badData.depleted ? 'depleted' : 'bad';
                
                row.innerHTML = `
                    <td>${goodData.year}</td>
                    <td class="${goodClass}">${formatCurrency(goodData.balance)}</td>
                    <td class="${badClass}">${formatCurrency(badData.balance)}</td>
                    <td class="avg">${formatCurrency(randomData.balance)}</td>
                    <td>${formatCurrency(avgData.balance)}</td>
                `;
                tbody.appendChild(row);
            }
        }
        
        loadTranslations();
    </script>
</body>
</html>
